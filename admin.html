<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - THE HOON STUDIO</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase SDK 추가 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
                // Firebase 설정 - 여기에 본인의 Firebase 설정값을 입력하세요
        const firebaseConfig = {
            apiKey: "AIzaSyDUJrHXzQfZ2-FwaZcuMcLu-71gRTVO2b4",
            authDomain: "the-hoon-studio.firebaseapp.com",
            projectId: "the-hoon-studio",
            storageBucket: "the-hoon-studio.firebasestorage.app",
            messagingSenderId: "857575526697",
            appId: "1:857575526697:web:43d66881a72f96e5a6e738"
        };

        
        // Firebase 초기화
        console.log('Firebase 초기화 시작...');
        const app = initializeApp(firebaseConfig);
        console.log('Firebase 앱 초기화 완료');
        
        const db = getFirestore(app);
        console.log('Firestore 초기화 완료');
        
        // 오프라인 지속성 비활성화 (문제 해결용)
        try {
            db._delegate._databaseId.projectId = firebaseConfig.projectId;
            console.log('오프라인 설정 적용 완료');
        } catch (error) {
            console.log('오프라인 설정 스킵:', error);
        }
        
        // 전역에서 사용할 수 있도록 설정
        window.db = db;
        window.firestoreFunctions = {
            collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy
        };
        
        console.log('Firebase 초기화 완료');
        console.log('window.db 설정됨:', !!window.db);
        console.log('window.firestoreFunctions 설정됨:', !!window.firestoreFunctions);
    </script>
    
    <style>
        /* 토스 스타일 관리자 페이지 전용 스타일 */
        body.admin-page {
            background-color: #000000;
            background-image: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #ffffff;
            margin: 0;
            padding: 0;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .admin-header {
            background: #111111;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 40px;
            border: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(20px);
        }

        .admin-title {
            font-family: 'Syncopate-Bold', sans-serif;
            font-size: 28px;
            color: #ffffff;
            margin: 0;
            font-weight: 700;
        }

        .logout-btn {
            background: #ffffff;
            color: #000000;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
        }

        /* Firebase 연결 상태 표시 */
        .firebase-status {
            padding: 16px;
            margin-bottom: 30px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid;
        }

        .firebase-connected {
            background: #0a0a0a;
            color: #00ff88;
            border-color: #00ff88;
        }

        .firebase-error {
            background: #0a0a0a;
            color: #ff4444;
            border-color: #ff4444;
        }

        /* 로그인 폼 - 토스 스타일 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #000000;
        }

        .login-form {
            background: #111111;
            padding: 50px;
            border-radius: 20px;
            border: 1px solid #333333;
            width: 100%;
            max-width: 450px;
            backdrop-filter: blur(20px);
        }

        .login-form h2 {
            font-family: 'Syncopate-Bold', sans-serif;
            text-align: center;
            margin-bottom: 40px;
            color: #ffffff;
            font-size: 28px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ffffff;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid #333333;
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            background: #0a0a0a;
            color: #ffffff;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ffffff;
            background: #111111;
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .btn {
            background: #ffffff;
            color: #000000;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            width: auto;
            min-width: 150px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,255,255,0.2);
        }

        .btn:disabled {
            background: #333333;
            color: #666666;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #00ff88;
            color: #000000;
        }

        .btn-success:hover {
            background: #00cc6a;
        }

        .btn-danger {
            background: #ff4444;
            color: #ffffff;
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
        }

        .btn-danger:hover {
            background: #ff2222;
        }

        .btn-edit {
            background: #ffffff;
            color: #000000;
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
            margin-right: 10px;
        }

        .btn-edit:hover {
            background: #f0f0f0;
        }

        /* 프로젝트 관리 영역 */
        .admin-section {
            background: #111111;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 40px;
            border: 1px solid #333333;
            backdrop-filter: blur(20px);
        }

        .section-title {
            font-family: 'Syncopate-Regular', sans-serif;
            font-size: 20px;
            margin-bottom: 30px;
            color: #ffffff;
            border-bottom: 2px solid #ffffff;
            padding-bottom: 15px;
            font-weight: 600;
        }

        .project-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            border-radius: 12px;
            overflow: hidden;
        }

        .project-table th,
        .project-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #333333;
        }

        .project-table th {
            background: #0a0a0a;
            font-weight: 600;
            color: #ffffff;
            font-size: 14px;
        }

        .project-table td {
            color: #ffffff;
            font-size: 14px;
        }

        .project-table tr:hover {
            background: #1a1a1a;
        }

        .alert {
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            font-weight: 500;
        }

        .alert-success {
            background: #0a0a0a;
            color: #00ff88;
            border: 1px solid #00ff88;
        }

        .alert-error {
            background: #0a0a0a;
            color: #ff4444;
            border: 1px solid #ff4444;
        }

        .hidden {
            display: none;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* 슬라이드 이미지 관리 스타일 추가 */
        .slide-images-container,
        .additional-images-container {
            margin-bottom: 20px;
        }

        .slide-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
            min-height: 60px;
            border: 2px dashed #333333;
            padding: 20px;
            border-radius: 12px;
            background: #0a0a0a;
        }

        .slide-preview-item {
            position: relative;
            background: #111111;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333333;
            cursor: move;
            transition: all 0.2s ease;
        }

        .slide-preview-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,255,255,0.1);
        }

        .slide-preview-img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }

        .slide-preview-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 8px;
        }

        .slide-control-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: rgba(0,0,0,0.8);
            color: #ffffff;
            transition: all 0.2s ease;
        }

        .delete-slide-btn {
            color: #ff4444;
        }

        .delete-slide-btn:hover {
            background: #ff4444;
            color: white;
            transform: scale(1.1);
        }

        .slide-preview-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .form-help {
            color: #999999;
            font-size: 12px;
            margin-top: 8px;
        }

        /* 이미지 미리보기 스타일 추가 */
        .image-preview-single {
            margin-top: 15px;
            max-width: 200px;
        }

        .image-preview-single img {
            width: 100%;
            height: auto;
            border-radius: 12px;
            border: 1px solid #333333;
        }

        .additional-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
            min-height: 50px;
            border: 2px dashed #333333;
            padding: 15px;
            border-radius: 12px;
            background: #0a0a0a;
        }

        .additional-preview-item {
            position: relative;
            background: #111111;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333333;
            transition: all 0.2s ease;
        }

        .additional-preview-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,255,255,0.1);
        }

        .additional-preview-img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            display: block;
        }

        /* 버튼 컨테이너 스타일 */
        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px; /* 버튼 사이 간격 */
            margin-top: 30px;
            flex-wrap: wrap; /* 화면이 작을 때 줄바꿈 */
        }
        
        /* 취소 버튼 스타일 */
        .btn-secondary {
            background: #333333;
            color: #ffffff;
        }
        
        .btn-secondary:hover {
            background: #444444;
        }

        /* 로그인 폼의 버튼은 예외적으로 전체 너비 유지 */
        .login-form .btn {
            width: 100%;
        }
        
        /* 테이블 내 버튼들은 기존 스타일 유지 */
        .btn-edit,
        .btn-danger {
            width: auto;
            min-width: auto;
            padding: 10px 20px;
            font-size: 14px;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .button-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .btn {
                width: 100%;
                min-width: auto;
            }
        }

        /* 로딩 스피너 */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #333333;
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 추가 토스 스타일 요소들 */
        .hidden {
            display: none !important;
        }

        .form-row {
            display: flex;
            gap: 25px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* 스크롤바 스타일링 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444444;
        }
    </style>
</head>
<body class="admin-page">
    <!-- 로그인 화면 - placeholder 제거 -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2>ADMIN LOGIN</h2>
            <div id="loginAlert" class="alert alert-error hidden"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">사용자명</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">비밀번호</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">로그인</button>
            </form>
        </div>
    </div>

    <!-- 관리자 대시보드 -->
    <div id="adminDashboard" class="hidden">
        <div class="admin-container">
            <!-- Firebase 연결 상태 -->
            <div id="firebaseStatus" class="firebase-status firebase-error">
                🔥 Firebase 연결을 확인하는 중...
            </div>

            <!-- 헤더 -->
            <div class="admin-header">
                <h1 class="admin-title">THE HOON STUDIO - Adminbereich</h1>
                <button id="logoutBtn" class="logout-btn">로그아웃</button>
            </div>

            <!-- 알림 메시지 -->
            <div id="alertMessage" class="alert hidden"></div>

            <!-- 프로젝트 추가 폼 -->
            <div class="admin-section">
                <h2 class="section-title">새 프로젝트 추가</h2>
                <form id="projectForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectName">PROJEKTNAME (z.B. abc.def)</label>
                            <input type="text" id="projectName" required placeholder="abc.def">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectCategory">Kategorie</label>
                            <select id="projectCategory" required>
                                <option value="architecture">ARCHITECTURE</option>
                                <option value="interior-rendering">INTERIOR DESIGN/RENDERING</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unterkategorie (Mehrfachauswahl möglich)</label>
                            <div id="projectCategories" style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px 18px; justify-items: start; max-width: 600px; margin: 0 auto 8px auto;">
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="D"> Design Development (D)</label>
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="P"> Building Permit (P)</label>
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="E"> Execution Planning (E)</label>
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="H"> Heritage Preservation (H)</label>
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="N"> New Construction (N)</label>
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="R"> Renovation (R)</label>
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="M/G"> Marketing/Graphic Design (M/G)</label>
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="I/R"> Interior Design/Rendering (I/R)</label>
                                <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 0.675em;"><input type="checkbox" name="projectCategories" value="C"> Competition (C)</label>
                        </div>
                        </div>
                        <!--
                        <div class="form-group">
                            <label for="projectCategory">KATEGORIE</label>
                            <select id="projectCategory" required>
                                <option value="">KATEGORIE AUSWAHL</option>
                                <option value="architecture">ARCHITECTURE</option>
                                <option value="interior-rendering">INTERIOR DESIGN/RENDERING</option>
                            </select>
                        </div>
                        -->
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectYear">JAHR</label>
                            <input type="number" id="projectYear" placeholder="2024 (선택사항)">
                        </div>
                        <div class="form-group">
                            <label for="projectStatus">STATUS</label>
                            <select id="projectStatus">
                                <option value="In Planning">In Planning</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="On Hold">On Hold</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectDeveloper">PROJEKTENTWICKLER</label>
                            <input type="text" id="projectDeveloper" placeholder="ABC DEVELOPMENT GMBH">
                        </div>
                        <div class="form-group">
                            <label for="projectManager">BAUHERR, PROJEKTSTEUERER UND VERMAKTUNG</label>
                            <input type="text" id="projectManager" placeholder="ABC CAPITAL + GRUNDBESITZ MÜNCHEN GMBH">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectPlanning">GENEHMIGUNGS- UND AUSFÜHRUNGSPLANUNG</label>
                            <input type="text" id="projectPlanning" placeholder="ABC ARCHITEKTEN PARTGMBH">
                        </div>
                        <div class="form-group">
                            <label for="projectStructure">TRAGWERKSPLANUNG</label>
                            <input type="text" id="projectStructure" placeholder="IB ABC KIES DR. ING ABC REINECKE">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectLocation">ORT</label>
                            <input type="text" id="projectLocation" placeholder="Munich">
                        </div>
                        <div class="form-group">
                            <label for="projectInterior">INTERIOR/RENDERING</label>
                            <input type="text" id="projectInterior" placeholder="THE HOON STUDIO">
                        </div>
                    </div>

                    <!-- 메인 이미지 섹션 -->
                    <div class="form-group">
                        <label for="projectImage">HAUPT-BILD (PROJEKTREPRÄSENTATIVES BILD):</label>
                        <input type="file" id="projectImage" name="projectImage" accept="image/*" required>
                        <div id="mainImagePreview" class="image-preview-single"></div>
                        <small class="form-help">Das Bild wird auf der Projektliste und der Detailseite oben angezeigt. (1MB 제한을 위한 강한 압축이 적용됩니다)</small>
                    </div>

                    <!-- 상세 슬라이드 이미지 섹션 -->
                    <div class="form-group">
                        <label for="slideImages">DETAIL-SLIDE-BILDER (LINKS/RECHTS SLIDE):</label>
                        <div class="slide-images-container">
                            <input type="file" id="slideImages" name="slideImages" accept="image/*" multiple>
                        </div>
                        <div class="slide-preview-container" id="slidePreviewContainer">
                            <!-- 선택된 이미지들의 미리보기가 여기에 표시됩니다 -->
                        </div>
                        <small class="form-help">Die Bilder, die Sie mit den Pfeiltasten durchblättern können, um auf der Detailseite anzuzeigen. (1MB 제한을 위한 강한 압축이 적용됩니다)</small>
                    </div>

                    <!-- 추가 이미지 섹션 -->
                    <div class="form-group">
                        <label for="additionalImages">ZUSÄTZLICHE GALERIE-BILDER (FÜR UNTERSEITEN-ABSCHNITT):</label>
                        <div class="additional-images-container">
                            <input type="file" id="additionalImages" name="additionalImages" accept="image/*" multiple>
                        </div>
                        <div class="additional-preview-container" id="additionalPreviewContainer">
                            <!-- 추가 이미지 미리보기 -->
                        </div>
                        <small class="form-help">Die Bilder, die auf der anderen Seite des anderen Abschnitts angezeigt werden. (1MB 제한을 위한 강한 압축이 적용됩니다)</small>
                    </div>

                    <div class="form-group">
                        <div class="button-container">
                            <button type="submit" class="btn btn-success" id="submitBtn">PROJEKT HINZUFÜGEN</button>
                            <button type="button" id="cancelEdit" class="btn btn-secondary hidden">ABBRECHEN</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 프로젝트 목록 -->
            <div class="admin-section">
                <h2 class="section-title">REGISTRIERTE PROJEKTE</h2>
                <div id="projectsLoader" class="hidden" style="text-align: center; padding: 20px;">
                    <div class="loading"></div> PROJEKT LADEN IN GEHENDE...
                </div>
                <table class="project-table">
                    <thead>
                        <tr>
                            <th>PROJEKTNAME</th>
                            <th>KATEGORIE</th>
                            <th>ORT</th>
                            <th>JAHR</th>
                            <th>STATUS</th>
                            <th>VERWALTEN</th>
                        </tr>
                    </thead>
                    <tbody id="projectList">
                        <!-- 프로젝트 목록이 여기에 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>

            <!-- 멤버 추가 섹션 -->
            <div class="admin-section">
                <h2 class="section-title">멤버 추가</h2>
                <form id="memberAddForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="memberName">이름</label>
                            <input type="text" id="memberName" required placeholder="이름">
                        </div>
                        <div class="form-group">
                            <label for="memberPosition">직책</label>
                            <input type="text" id="memberPosition" required placeholder="직책">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="memberEmail">이메일</label>
                            <input type="email" id="memberEmail" required placeholder="이메일">
                        </div>
                        <div class="form-group">
                            <label for="memberImage">프로필 이미지</label>
                            <input type="file" id="memberImage" accept="image/*" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="button-container">
                            <button type="submit" class="btn btn-success">멤버 추가</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 팀 멤버 목록 -->
            <div class="admin-section">
                <h2 class="section-title">등록된 팀 멤버</h2>
                <div id="membersLoader" class="hidden" style="text-align: center; padding: 20px;">
                    <div class="loading"></div> 멤버 로딩 중...
                </div>
                <table class="project-table">
                    <thead>
                        <tr>
                            <th>이름</th>
                            <th>직책</th>
                            <th>이메일</th>
                            <th>이미지</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="membersList">
                        <!-- 팀 멤버 목록이 여기에 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 관리자 인증 정보 (실제 서비스에서는 서버에서 처리해야 함)
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: '1234'
        };

        let isLoggedIn = false;
        let editingProjectId = null;
        let editingProjectName = null;
        
        // Firebase 상태 체크
        let isFirebaseReady = false;

        // Firebase 준비 상태 확인
        function checkFirebaseReady() {
            return new Promise((resolve) => {
                console.log('Firebase 준비 상태 확인 시작');
                console.log('window.db:', window.db);
                console.log('window.firestoreFunctions:', window.firestoreFunctions);
                
                // 즉시 확인
                if (window.db && window.firestoreFunctions) {
                    isFirebaseReady = true;
                    console.log('Firebase 즉시 준비 완료!');
                    updateFirebaseStatus(true);
                    resolve(true);
                    return;
                }
                
                const checkInterval = setInterval(() => {
                    if (window.db && window.firestoreFunctions) {
                        clearInterval(checkInterval);
                        isFirebaseReady = true;
                        console.log('Firebase 준비 완료!');
                        updateFirebaseStatus(true);
                        resolve(true);
                    }
                }, 100);
                
                // 10초 후 타임아웃
                setTimeout(() => {
                    clearInterval(checkInterval);
                    if (!isFirebaseReady) {
                        console.log('Firebase 초기화 타임아웃');
                        updateFirebaseStatus(false, 'Firebase 초기화 타임아웃');
                        resolve(false);
                    }
                }, 10000);
            });
        }

        // Firebase 상태 업데이트
        function updateFirebaseStatus(connected, errorMsg = '') {
            const statusElement = document.getElementById('firebaseStatus');
            if (connected) {
                statusElement.className = 'firebase-status firebase-connected';
                statusElement.textContent = '🔥 Firebase 연결됨 - 온라인 데이터베이스 사용 중';
            } else {
                statusElement.className = 'firebase-status firebase-error';
                statusElement.textContent = `❌ Firebase 연결 실패: ${errorMsg || 'Firebase 설정을 확인해주세요'}`;
            }
        }

        // Firestore 보안 규칙 안내
        function showFirestoreRulesHelp() {
            const helpText = `
Firestore 보안 규칙 문제일 수 있습니다. 
Firebase Console > Firestore Database > Rules에서 다음 규칙을 설정해주세요:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}

⚠️ 주의: 이 규칙은 모든 접근을 허용합니다. 프로덕션에서는 더 엄격한 규칙을 사용하세요.
            `;
            console.log(helpText);
            showAlert('Firestore 보안 규칙을 확인해주세요. 콘솔에서 자세한 안내를 확인하세요.', 'error');
        }

        // Firestore에서 프로젝트 데이터 가져오기 (간소화 버전)
        async function getProjects() {
            if (!isFirebaseReady) {
                console.log('Firebase가 준비되지 않았습니다.');
                return {};
            }

            try {
                const { collection, getDocs } = window.firestoreFunctions;
                
                // 간단한 컬렉션 읽기로 변경 (orderBy 제거)
                const querySnapshot = await getDocs(collection(window.db, "projects"));
                
                const projects = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    projects[data.name] = {
                        id: doc.id,
                        ...data
                    };
                });
                
                console.log('Firestore에서 프로젝트 가져오기 성공:', Object.keys(projects).length + '개');
                return projects;
            } catch (error) {
                console.error('Firestore 프로젝트 가져오기 실패:', error);
                console.error('에러 세부사항:', error);
                
                // 에러가 권한 관련인지 확인
                if (error.code === 'permission-denied') {
                    showAlert('Firestore 접근 권한이 없습니다. 보안 규칙을 확인해주세요.', 'error');
                } else {
                    showAlert('프로젝트를 불러오는데 실패했습니다: ' + error.message, 'error');
                }
                return {};
            }
        }

        // 개별 프로젝트 저장
        async function saveProjectToFirestore(projectData) {
            if (!isFirebaseReady) {
                throw new Error('Firebase가 준비되지 않았습니다.');
            }

            try {
                const { collection, addDoc } = window.firestoreFunctions;
                
                // 생성 시간 추가
                projectData.createdAt = new Date();
                projectData.updatedAt = new Date();
                
                console.log('Firestore 저장 시도 - 컬렉션: projects');
                console.log('데이터 크기:', JSON.stringify(projectData).length, 'bytes');
                console.log('네트워크 상태:', navigator.onLine);
                console.log('Firebase 연결 상태:', isFirebaseReady);
                console.log('window.db:', window.db);
                console.log('window.firestoreFunctions:', window.firestoreFunctions);
                
                const docRef = await addDoc(collection(window.db, "projects"), projectData);
                console.log('Firestore 프로젝트 저장 성공. 문서 ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Firestore 프로젝트 저장 실패:', error);
                console.error('에러 코드:', error.code);
                console.error('에러 메시지:', error.message);
                console.error('에러 스택:', error.stack);
                
                // 권한 관련 에러인지 확인
                if (error.code === 'permission-denied') {
                    showFirestoreRulesHelp();
                    throw new Error('Firestore 접근 권한이 없습니다. 보안 규칙을 확인해주세요.');
                } else if (error.code === 'resource-exhausted') {
                    throw new Error('Firestore 저장 공간이 부족합니다.');
                } else if (error.code === 'invalid-argument') {
                    throw new Error('잘못된 데이터 형식입니다.');
                } else if (error.code === 'unavailable') {
                    throw new Error('Firestore 서비스가 일시적으로 사용할 수 없습니다.');
                } else if (error.code === 'deadline-exceeded') {
                    throw new Error('요청 시간이 초과되었습니다.');
                }
                
                throw error;
            }
        }

        // 프로젝트 업데이트
        async function updateProjectInFirestore(projectId, projectData) {
            if (!isFirebaseReady) {
                throw new Error('Firebase가 준비되지 않았습니다.');
            }

            try {
                const { doc, updateDoc } = window.firestoreFunctions;
                
                // 업데이트 시간 추가
                projectData.updatedAt = new Date();
                
                await updateDoc(doc(window.db, "projects", projectId), projectData);
                console.log('Firestore 프로젝트 업데이트 성공. 문서 ID:', projectId);
            } catch (error) {
                console.error('Firestore 프로젝트 업데이트 실패:', error);
                throw error;
            }
        }

        // 프로젝트 삭제
        async function deleteProjectFromFirestore(projectId) {
            if (!isFirebaseReady) {
                throw new Error('Firebase가 준비되지 않았습니다.');
            }

            try {
                const { doc, deleteDoc } = window.firestoreFunctions;
                await deleteDoc(doc(window.db, "projects", projectId));
                console.log('Firestore 프로젝트 삭제 성공. 문서 ID:', projectId);
            } catch (error) {
                console.error('Firestore 프로젝트 삭제 실패:', error);
                throw error;
            }
        }

        // 알림 메시지 표시
        function showAlert(message, type = 'success') {
            const alertElement = document.getElementById('alertMessage');
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.classList.remove('hidden');
            
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, 5000);
        }

        // 로딩 상태 토글 (간소화)
        function toggleSubmitLoading(loading) {
            const submitBtn = document.getElementById('submitBtn');
            
            if (loading) {
                submitBtn.disabled = true;
                submitBtn.textContent = '처리 중...';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = editingProjectName ? '프로젝트 수정' : '프로젝트 추가';
            }
        }

        // 로그인 처리
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                isLoggedIn = true;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                
                // Firebase 준비 확인 후 프로젝트와 멤버 로드
                checkFirebaseReady().then(() => {
                    loadProjects();
                    loadMembers(); // 팀 멤버 목록도 함께 로드
                });
            } else {
                const loginAlert = document.getElementById('loginAlert');
                loginAlert.textContent = '사용자명 또는 비밀번호가 잘못되었습니다.';
                loginAlert.classList.remove('hidden');
            }
        });

        // 로그아웃 처리
        document.getElementById('logoutBtn').addEventListener('click', function() {
            isLoggedIn = false;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginAlert').classList.add('hidden');
        });

        // 슬라이드 이미지 관리 변수
        let slideImages = [];
        let additionalImages = []; // 추가 이미지 배열 추가
        let draggedElement = null;

        // 이미지를 base64로 변환하는 함수 추가
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // compressImage 함수 - 1MB 제한 내에서 최대 화질로 자동 압축
        async function compressImage(file, maxWidth = 1200, quality = 1.0) {
            const minQuality = 0.5;
            const minWidth = 600;
            let curQuality = quality;
            let curWidth = maxWidth;
            let compressedDataUrl = null;
            let sizeInKB = 0;
            
            while (curWidth >= minWidth) {
                curQuality = quality;
                while (curQuality >= minQuality) {
                    compressedDataUrl = await new Promise((resolve) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.onload = () => {
                            const ratio = Math.min(curWidth / img.width, curWidth / img.height);
                            canvas.width = img.width * ratio;
                            canvas.height = img.height * ratio;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', curQuality));
                        };
                        img.src = URL.createObjectURL(file);
                    });
                    sizeInKB = (compressedDataUrl.length * 0.75) / 1024;
                    if (sizeInKB <= 1024) {
                        console.log(`이미지 압축 완료: ${sizeInKB.toFixed(2)}KB (해상도: ${curWidth}px, 화질: ${curQuality * 100}%)`);
                        return compressedDataUrl;
                    }
                    curQuality -= 0.1;
                }
                curWidth -= 200;
            }
            // 마지막 시도(최소 해상도, 최소 품질)
            console.warn('1MB 이하로 압축 불가, 최저 화질로 저장');
            return compressedDataUrl;
        }

        // 슬라이드 이미지 자동 추가 함수 수정 (최대 3개 제한)
        document.getElementById('slideImages').addEventListener('change', async function() {
            const files = this.files;
            
            if (files.length === 0) return;
            
            // 개수 제한 없이 모두 추가
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const imageId = Date.now() + '-slide-' + i;
                
                try {
                    // 이미지 압축 후 base64로 변환 (최대 화질)
                    const compressedBase64 = await compressImage(file, 1200, 1.0);
                    
                    slideImages.push({
                        id: imageId,
                        file: file,
                        url: compressedBase64 // base64 URL 저장
                    });
                    
                    console.log('슬라이드 이미지 압축 완료:', (compressedBase64.length / 1024).toFixed(2) + 'KB');
                } catch (error) {
                    console.error('슬라이드 이미지 처리 실패:', error);
                    alert('이미지 처리 중 오류가 발생했습니다: ' + file.name);
                }
            }
            
            renderSlidePreview();
            this.value = ''; // 같은 파일을 다시 선택할 수 있도록 초기화
        });

        // 추가 이미지 자동 추가 함수 수정
        document.getElementById('additionalImages').addEventListener('change', async function() {
            const files = this.files;
            
            if (files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const imageId = Date.now() + '-additional-' + i;
                
                try {
                    // 이미지 압축 후 base64로 변환 (1MB 제한을 위한 강한 압축)
                    const compressedBase64 = await compressImage(file, 600, 0.5);
                    
                    additionalImages.push({
                        id: imageId,
                        file: file,
                        url: compressedBase64 // base64 URL 저장
                    });
                    
                    console.log('추가 이미지 압축 완료:', (compressedBase64.length / 1024).toFixed(2) + 'KB');
                } catch (error) {
                    console.error('추가 이미지 처리 실패:', error);
                    alert('이미지 처리 중 오류가 발생했습니다: ' + file.name);
                }
            }
            
            renderAdditionalPreview();
            this.value = ''; // 같은 파일을 다시 선택할 수 있도록 초기화
        });

        // 슬라이드 미리보기 렌더링
        function renderSlidePreview() {
            const container = document.getElementById('slidePreviewContainer');
            
            if (slideImages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; margin: 20px 0;">선택된 슬라이드 이미지가 없습니다.</p>';
                return;
            }
            
            container.innerHTML = slideImages.map((img, index) => `
                <div class="slide-preview-item" draggable="true" data-id="${img.id}" data-index="${index}">
                    <img src="${img.url}" alt="슬라이드 ${index + 1}" class="slide-preview-img">
                    <div class="slide-preview-controls">
                        <button type="button" class="slide-control-btn delete-slide-btn" onclick="removeSlideImage('${img.id}')">×</button>
                    </div>
                </div>
            `).join('');
            
            // 드래그 앤 드롭 이벤트 추가
            addDragDropEvents();
        }

        // 슬라이드 이미지 삭제
        function removeSlideImage(imageId) {
            slideImages = slideImages.filter(img => img.id !== imageId);
            renderSlidePreview();
        }

        // 드래그 앤 드롭 기능
        function addDragDropEvents() {
            const items = document.querySelectorAll('.slide-preview-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            
            if (this !== draggedElement) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // 배열에서 위치 변경
                const draggedItem = slideImages[draggedIndex];
                slideImages.splice(draggedIndex, 1);
                slideImages.splice(targetIndex, 0, draggedItem);
                
                renderSlidePreview();
            }
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
        }

        // 프로젝트 저장 함수 수정
        function saveProject() {
            const form = document.getElementById('projectForm');
            const formData = new FormData(form);
            
            // 기본 프로젝트 정보
            const projectData = {
                id: formData.get('projectId'),
                name: formData.get('projectName'),
                number: formData.get('projectNumber'),
                category: formData.get('projectCategory'),
                year: formData.get('projectYear'),
                location: formData.get('projectLocation'),
                size: formData.get('projectSize'),
                description: formData.get('projectDescription'),
                mainImage: '', // 메인 이미지 URL
                slideImages: [] // 슬라이드 이미지 URLs
            };
            
            // 메인 이미지 처리
            const mainImageFile = formData.get('projectImage');
            if (mainImageFile && mainImageFile.size > 0) {
                projectData.mainImage = URL.createObjectURL(mainImageFile);
            }
            
            // 슬라이드 이미지들 처리
            projectData.slideImages = slideImages.map(img => img.url);
            
            // localStorage에 저장
            let projects = JSON.parse(localStorage.getItem('projects') || '[]');
            
            // 기존 프로젝트 업데이트 또는 새 프로젝트 추가
            const existingIndex = projects.findIndex(p => p.id === projectData.id);
            if (existingIndex !== -1) {
                projects[existingIndex] = projectData;
                alert('프로젝트가 수정되었습니다!');
            } else {
                projects.push(projectData);
                alert('프로젝트가 등록되었습니다!');
            }
            
            localStorage.setItem('projects', JSON.stringify(projects));
            
            // 폼 초기화
            form.reset();
            slideImages = [];
            renderSlidePreview();
            
            loadProjects(); // 프로젝트 목록 새로고침
        }

        // 페이지 로드 시 초기화 - 간소화
        document.addEventListener('DOMContentLoaded', function() {
            renderSlidePreview();
            renderAdditionalPreview();
            
            // Firebase 초기화 체크
            checkFirebaseReady();
            
            console.log('관리자 페이지 초기화 완료'); // 디버깅용
        });

        // 수정 버튼 클릭 핸들러 (로딩 상태 관리)
        async function handleEditProject(buttonElement, projectName) {
            const originalText = buttonElement.textContent;
            buttonElement.disabled = true;
            buttonElement.textContent = '로딩...';
            
            try {
                await editProject(projectName);
            } catch (error) {
                console.error('프로젝트 수정 실패:', error);
                showAlert('프로젝트 수정에 실패했습니다.', 'error');
            } finally {
                buttonElement.disabled = false;
                buttonElement.textContent = originalText;
            }
        }

        // 프로젝트 수정 함수 수정 (로딩 문제 해결)
        async function editProject(projectName) {
            try {
                // Firebase가 준비되지 않았으면 localStorage에서 가져오기
                let firestoreProjects = {};
                
                if (isFirebaseReady) {
                    // 타임아웃 설정 (3초)
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('타임아웃')), 3000)
                    );
                    
                    try {
                        firestoreProjects = await Promise.race([getProjects(), timeoutPromise]);
                    } catch (error) {
                        console.log('Firestore에서 가져오기 실패, localStorage 사용:', error.message);
                        // Firestore 실패시 localStorage에서 가져오기
                        const localProjects = localStorage.getItem('adminProjects');
                        firestoreProjects = localProjects ? JSON.parse(localProjects) : {};
                    }
                } else {
                    // Firebase가 준비되지 않았으면 localStorage에서 가져오기
                    console.log('Firebase 준비되지 않음, localStorage 사용');
                    const localProjects = localStorage.getItem('adminProjects');
                    firestoreProjects = localProjects ? JSON.parse(localProjects) : {};
                }
                
                const project = firestoreProjects[projectName];
                
                if (!project) {
                    console.log('프로젝트를 찾을 수 없습니다:', projectName);
                    showAlert('프로젝트를 찾을 수 없습니다.', 'error');
                    return;
                }

                console.log('수정할 프로젝트 데이터:', project);

                editingProjectId = project.id;
                editingProjectName = projectName;
                
                // 기본 정보 입력
                document.getElementById('projectName').value = project.name || '';
                document.getElementById('projectCategory').value = project.category || '';
                document.getElementById('projectLocation').value = project.location || '';
                document.getElementById('projectYear').value = project.year || '';
                document.getElementById('projectStatus').value = project.status || 'In Planning';
                document.getElementById('projectDeveloper').value = project.developer || '';
                document.getElementById('projectManager').value = project.manager || '';
                document.getElementById('projectPlanning').value = project.planning || '';
                document.getElementById('projectStructure').value = project.structure || '';
                document.getElementById('projectInterior').value = project.interior || 'THE HOON STUDIO';
                
                // 수정 모드에서는 메인 이미지 required 속성 제거
                const mainImageInput = document.getElementById('projectImage');
                mainImageInput.removeAttribute('required');
                
                // 메인 이미지 미리보기
                const mainImagePreview = document.getElementById('mainImagePreview');
                if (project.image) {
                    const img = document.createElement('img');
                    img.src = project.image;
                    img.alt = '메인 이미지 미리보기';
                    mainImagePreview.innerHTML = '';
                    mainImagePreview.appendChild(img);
                    
                    // 기존 이미지를 dataset에 저장 (폼 제출 시 사용)
                    mainImagePreview.dataset.compressedImage = project.image;
                } else {
                    mainImagePreview.innerHTML = '';
                    delete mainImagePreview.dataset.compressedImage;
                }
                
                // 상세 슬라이드 이미지들 불러오기
                slideImages = [];
                if (project.images && Array.isArray(project.images)) {
                    project.images.forEach((imageUrl, index) => {
                        slideImages.push({
                            id: 'existing-slide-' + index,
                            file: null,
                            url: imageUrl
                        });
                    });
                }
                renderSlidePreview();
                
                // 추가 이미지들 불러오기
                additionalImages = [];
                if (project.additionalImages && Array.isArray(project.additionalImages)) {
                    project.additionalImages.forEach((imageUrl, index) => {
                        additionalImages.push({
                            id: 'existing-additional-' + index,
                            file: null,
                            url: imageUrl
                        });
                    });
                }
                renderAdditionalPreview();
                
                // 카테고리 체크박스 채우기 (배열/문자열 모두 대응)
                const checkboxes = document.querySelectorAll('input[name="projectCategories"]');
                checkboxes.forEach(cb => cb.checked = false);
                let categories = project.category;
                if (!Array.isArray(categories)) {
                    categories = categories ? [categories] : [];
                }
                categories.forEach(cat => {
                    const checkbox = document.querySelector(`input[name="projectCategories"][value="${cat}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                
                // 하이라이트 체크박스 제거됨

                // 수정 모드 UI 표시
                document.getElementById('cancelEdit').classList.remove('hidden');
                
                // 버튼 텍스트 변경
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.textContent = '프로젝트 수정';
                
                // 폼으로 스크롤
                document.querySelector('.admin-section').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('프로젝트 수정 로드 실패:', error);
                showAlert('프로젝트 정보를 불러오는데 실패했습니다.', 'error');
            }
        }

        // 수정 취소 버튼 수정
        document.getElementById('cancelEdit').addEventListener('click', function() {
            editingProjectId = null;
            editingProjectName = null;
            
            // 폼 초기화
            document.getElementById('projectForm').reset();
            
            // 새 프로젝트 추가 모드로 돌아갈 때 required 속성 다시 추가
            const mainImageInput = document.getElementById('projectImage');
            mainImageInput.setAttribute('required', 'required');
            
            // 이미지 배열 초기화
            slideImages = [];
            additionalImages = [];
            
            // 미리보기 초기화
            renderSlidePreview();
            renderAdditionalPreview();
            document.getElementById('mainImagePreview').innerHTML = '';
            
            // UI 초기화
            this.classList.add('hidden');
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = '프로젝트 추가';
        });

        // 프로젝트 폼 제출 처리 - Firebase 버전
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            toggleSubmitLoading(true);
            
            console.log('=== 프로젝트 저장 시작 ===');
            console.log('Firebase 상태:', isFirebaseReady);
            console.log('로그인 상태:', isLoggedIn);
            console.log('window.db:', window.db);
            console.log('window.firestoreFunctions:', window.firestoreFunctions);
            
            try {
                // 폼 데이터 수집
                const projectName = document.getElementById('projectName').value;
                const projectCategory = document.getElementById('projectCategory').value;
                const projectLocation = document.getElementById('projectLocation').value;
                const projectYear = document.getElementById('projectYear').value;
                const projectStatus = document.getElementById('projectStatus').value;
                const projectDeveloper = document.getElementById('projectDeveloper').value;
                const projectManager = document.getElementById('projectManager').value;
                const projectPlanning = document.getElementById('projectPlanning').value;
                const projectStructure = document.getElementById('projectStructure').value;
                const projectInterior = document.getElementById('projectInterior').value;
                
                // 메인 이미지 처리
                let mainImageUrl = '';
                const mainImageFile = document.getElementById('projectImage').files[0];
                const previewContainer = document.getElementById('mainImagePreview');
                
                if (mainImageFile) {
                    // 새로운 이미지가 선택된 경우
                    mainImageUrl = await compressImage(mainImageFile, 600, 0.5);
                    console.log('새 메인 이미지 압축 완료');
                } else if (previewContainer.dataset.compressedImage) {
                    // 기존 이미지가 있는 경우 (수정 모드에서 새 이미지를 선택하지 않았을 때)
                    mainImageUrl = previewContainer.dataset.compressedImage;
                    console.log('기존 메인 이미지 사용');
                } else if (!editingProjectName) {
                    // 새 프로젝트 추가 모드인데 이미지가 없는 경우에만 에러
                    throw new Error('메인 이미지를 선택해주세요.');
                }
                
                // 상세 슬라이드 이미지들
                const detailSlideImages = slideImages.map(img => img.url);
                
                // 추가 이미지들
                const additionalSlideImages = additionalImages.map(img => img.url);
                
                console.log('처리된 이미지 데이터:');
                console.log('메인 이미지 크기:', mainImageUrl ? (mainImageUrl.length / 1024).toFixed(2) + 'KB' : '없음');
                console.log('상세 슬라이드 이미지 수:', detailSlideImages.length);
                console.log('추가 이미지 수:', additionalSlideImages.length);
                
                // 프로젝트 데이터 생성
                const projectData = {
                    name: projectName,
                    category: projectCategory,
                    location: projectLocation,
                    year: projectYear ? parseInt(projectYear) : null,
                    status: projectStatus,
                    developer: projectDeveloper,
                    manager: projectManager,
                    planning: projectPlanning,
                    structure: projectStructure,
                    interior: projectInterior,
                    
                    // 이미지들 (모두 base64 형태로 저장)
                    mainImage: mainImageUrl,                    // 메인 이미지 (필드명 변경)
                    images: detailSlideImages,              // 상세 슬라이드 이미지들
                    additionalImages: additionalSlideImages // 추가 갤러리 이미지들
                };
                // 세부카테고리(체크박스) 값 저장
                projectData.categoryDetail = Array.from(document.querySelectorAll('input[name="projectCategories"]:checked')).map(cb => cb.value);

                // 하이라이트 체크박스 제거됨 - 모든 프로젝트가 하이라이트에 표시됨

                // Firebase 또는 localStorage 저장
                try {
                    console.log('저장 시도 - Firebase 준비:', isFirebaseReady, '수정 모드:', editingProjectId);
                    console.log('프로젝트 데이터 크기:', JSON.stringify(projectData).length, 'bytes');
                    
                    if (isFirebaseReady && editingProjectId) {
                        // Firebase 수정 모드
                        console.log('Firebase 수정 모드로 저장 시도');
                        await updateProjectInFirestore(editingProjectId, projectData);
                        showAlert('프로젝트가 성공적으로 수정되었습니다!');
                    } else if (isFirebaseReady) {
                        // Firebase 새 프로젝트 추가
                        console.log('Firebase 새 프로젝트 추가 시도');
                        const docId = await saveProjectToFirestore(projectData);
                        showAlert('프로젝트가 성공적으로 추가되었습니다!');
                    } else {
                        // Firebase 연결 안됨 - localStorage만 사용
                        console.log('Firebase 연결 안됨, localStorage 사용');
                        console.log('Firebase 준비 상태:', isFirebaseReady);
                        console.log('window.db:', window.db);
                        console.log('window.firestoreFunctions:', window.firestoreFunctions);
                        
                        // localStorage에 저장
                        let localProjects = JSON.parse(localStorage.getItem('adminProjects') || '{}');
                        let projectsArray = JSON.parse(localStorage.getItem('projects') || '[]');
                        
                        if (editingProjectName) {
                            // 수정 모드
                            delete localProjects[editingProjectName];
                            projectsArray = projectsArray.filter(p => p.name !== editingProjectName);
                        }
                        
                        // 새 프로젝트 추가
                        localProjects[projectData.name] = projectData;
                        projectsArray.push(projectData);
                        
                        localStorage.setItem('adminProjects', JSON.stringify(localProjects));
                        localStorage.setItem('projects', JSON.stringify(projectsArray));
                        
                        showAlert('프로젝트가 로컬에 저장되었습니다! (Firebase 연결 후 동기화됩니다)', 'success');
                    }
                } catch (firebaseError) {
                    console.error('Firebase 저장 실패, localStorage 사용:', firebaseError);
                    console.error('Firebase 에러 상세:', firebaseError);
                    console.error('에러 코드:', firebaseError.code);
                    console.error('에러 메시지:', firebaseError.message);
                    console.error('에러 스택:', firebaseError.stack);
                    
                    // 네트워크 상태 확인
                    console.log('네트워크 상태:', navigator.onLine);
                    console.log('Firebase 연결 상태:', isFirebaseReady);
                    
                    // Firebase 실패시 localStorage에 저장 (용량 제한 고려)
                    try {
                        let localProjects = JSON.parse(localStorage.getItem('adminProjects') || '{}');
                        let projectsArray = JSON.parse(localStorage.getItem('projects') || '[]');
                        
                        if (editingProjectName) {
                            delete localProjects[editingProjectName];
                            projectsArray = projectsArray.filter(p => p.name !== editingProjectName);
                        }
                        
                        localProjects[projectData.name] = projectData;
                        projectsArray.push(projectData);
                        
                        localStorage.setItem('adminProjects', JSON.stringify(localProjects));
                        localStorage.setItem('projects', JSON.stringify(projectsArray));
                    } catch (localStorageError) {
                        console.error('localStorage 저장 실패:', localStorageError);
                        showAlert('localStorage 용량 부족으로 저장할 수 없습니다. 브라우저 데이터를 정리해주세요.', 'error');
                    }
                    
                    let errorMessage = firebaseError.message;
                    if (firebaseError.code === 'permission-denied') {
                        errorMessage = 'Firestore 권한 문제 - 보안 규칙을 확인해주세요';
                    } else if (firebaseError.code === 'resource-exhausted') {
                        errorMessage = 'Firestore 저장공간 부족';
                    }
                    
                    showAlert('Firebase 저장 실패, 로컬에 저장되었습니다. (에러: ' + errorMessage + ')', 'success');
                }
                
                // 수정 모드 정리
                if (editingProjectName) {
                    editingProjectId = null;
                    editingProjectName = null;
                    document.getElementById('cancelEdit').classList.add('hidden');
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.textContent = '프로젝트 추가';
                    
                    // required 속성 다시 추가
                    const mainImageInput = document.getElementById('projectImage');
                    mainImageInput.setAttribute('required', 'required');
                }
                
                console.log('=== 프로젝트 저장 성공 ===');
                
                // 프로젝트 목록 새로고침
                loadProjects();
                
                // 폼 초기화
                document.getElementById('projectForm').reset();
                slideImages = [];
                additionalImages = [];
                renderSlidePreview();
                renderAdditionalPreview();
                document.getElementById('mainImagePreview').innerHTML = '';
                
                // 실시간 반영
                window.dispatchEvent(new Event('adminProjectsUpdated'));
                
            } catch (error) {
                console.error('프로젝트 저장 실패:', error);
                
                if (error.message.includes('quota') || error.message.includes('storage')) {
                    showAlert('Firestore 저장 공간이 부족합니다! 이미지 크기를 더 줄이거나 기존 프로젝트를 삭제해주세요.', 'error');
                } else {
                    showAlert('프로젝트 저장 중 오류가 발생했습니다: ' + error.message, 'error');
                }
            } finally {
                toggleSubmitLoading(false);
            }
        });

        // Firestore 데이터를 localStorage에 동기화 (기존 프로젝트 페이지 호환성을 위해)
        async function syncToLocalStorage() {
            try {
                const firestoreProjects = await getProjects();
                const projectsArray = Object.values(firestoreProjects);
                
                localStorage.setItem('projects', JSON.stringify(projectsArray));
                localStorage.setItem('adminProjects', JSON.stringify(firestoreProjects));
                
                // 프로젝트 페이지에 실시간 반영
                window.dispatchEvent(new Event('adminProjectsUpdated'));
                
                console.log('localStorage 동기화 완료:', projectsArray.length + '개 프로젝트');
            } catch (error) {
                console.error('localStorage 동기화 실패:', error);
            }
        }

        // 프로젝트 목록 로드 - Firebase/localStorage 하이브리드
        async function loadProjects() {
            const projectList = document.getElementById('projectList');
            const loader = document.getElementById('projectsLoader');
            
            try {
                loader.classList.remove('hidden');
                projectList.innerHTML = '';

                let projects = {};
                
                if (isFirebaseReady) {
                    try {
                        projects = await getProjects();
                        console.log('Firebase에서 프로젝트 로드 성공');
                    } catch (error) {
                        console.log('Firebase 로드 실패, localStorage 사용:', error);
                        const localProjects = localStorage.getItem('adminProjects');
                        projects = localProjects ? JSON.parse(localProjects) : {};
                    }
                } else {
                    console.log('Firebase 준비 안됨, localStorage 사용');
                    const localProjects = localStorage.getItem('adminProjects');
                    projects = localProjects ? JSON.parse(localProjects) : {};
                }
                
                if (Object.keys(projects).length === 0) {
                    projectList.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">등록된 프로젝트가 없습니다.</td></tr>';
                } else {
                    // 프로젝트를 카테고리별로 정렬
                    const sortedProjects = Object.entries(projects).sort((a, b) => {
                        const categoryA = a[1].category.toLowerCase();
                        const categoryB = b[1].category.toLowerCase();
                        
                        // 아키텍처가 먼저, 인테리어가 나중에 오도록 정렬
                        if (categoryA === 'architecture' && categoryB !== 'architecture') {
                            return -1;
                        }
                        if (categoryA !== 'architecture' && categoryB === 'architecture') {
                            return 1;
                        }
                        
                        // 같은 카테고리 내에서는 이름순 정렬
                        return a[0].localeCompare(b[0]);
                    });
                    
                    sortedProjects.forEach(([projectName, project]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${project.name}</td>
                            <td>${project.category.toUpperCase()}</td>
                            <td>${project.location}</td>
                            <td>${project.year || '-'}</td>
                            <td>${project.status}</td>
                            <td>
                                <button class="btn-edit" onclick="handleEditProject(this, '${projectName}')">수정</button>
                                <button class="btn-danger" onclick="deleteProject('${projectName}', '${project.id}')">삭제</button>
                            </td>
                        `;
                        projectList.appendChild(row);
                    });
                }

                // localStorage 동기화 (간소화)
                const projectsArray = Object.values(projects);
                try {
                    localStorage.setItem('projects', JSON.stringify(projectsArray));
                    localStorage.setItem('adminProjects', JSON.stringify(projects));
                } catch (e) {
                    console.warn('localStorage 용량 초과, 저장을 건너뜁니다.', e);
                }
                
            } catch (error) {
                console.error('프로젝트 로드 실패:', error);
                projectList.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">프로젝트 로드에 실패했습니다.</td></tr>';
                showAlert('프로젝트 목록을 불러오는데 실패했습니다.', 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // 프로젝트 삭제 - Firebase 버전
        async function deleteProject(projectName, projectId) {
            if (!isFirebaseReady) {
                showAlert('Firebase 연결을 확인해주세요.', 'error');
                return;
            }

            if (confirm(`"${projectName}" 프로젝트를 정말 삭제하시겠습니까?`)) {
                try {
                    await deleteProjectFromFirestore(projectId);
                    showAlert('프로젝트가 삭제되었습니다!');
                    
                    // 프로젝트 목록 새로고침
                    await loadProjects();
                    
                } catch (error) {
                    console.error('프로젝트 삭제 실패:', error);
                    showAlert('프로젝트 삭제에 실패했습니다: ' + error.message, 'error');
                }
            }
        }

        // 메인 이미지 미리보기
        document.getElementById('projectImage').addEventListener('change', async function() {
            const file = this.files[0];
            const previewContainer = document.getElementById('mainImagePreview');
            
            if (file) {
                try {
                    // 이미지 압축 후 base64로 변환 (1MB 제한을 위한 강한 압축)
                    const compressedBase64 = await compressImage(file, 600, 0.5);
                    
                    const img = document.createElement('img');
                    img.src = compressedBase64;
                    img.alt = '메인 이미지 미리보기';
                    previewContainer.innerHTML = '';
                    previewContainer.appendChild(img);
                    
                    // 압축된 이미지를 임시 저장 (폼 제출 시 사용)
                    previewContainer.dataset.compressedImage = compressedBase64;
                    
                    console.log('메인 이미지 압축 완료:', (compressedBase64.length / 1024).toFixed(2) + 'KB');
                } catch (error) {
                    console.error('메인 이미지 처리 실패:', error);
                    alert('메인 이미지 처리 중 오류가 발생했습니다.');
                }
            } else {
                previewContainer.innerHTML = '';
                delete previewContainer.dataset.compressedImage;
            }
        });

        function renderAdditionalPreview() {
            const container = document.getElementById('additionalPreviewContainer');
            
            if (additionalImages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; margin: 10px 0;">추가 이미지가 없습니다.</p>';
                return;
            }
            
            container.innerHTML = additionalImages.map((img, index) => `
                <div class="additional-preview-item" data-id="${img.id}">
                    <img src="${img.url}" alt="추가 이미지 ${index + 1}" class="additional-preview-img">
                    <div class="slide-preview-controls">
                        <button type="button" class="slide-control-btn delete-slide-btn" onclick="removeAdditionalImage('${img.id}')">×</button>
                    </div>
                </div>
            `).join('');
        }

        function removeAdditionalImage(imageId) {
            additionalImages = additionalImages.filter(img => img.id !== imageId);
            renderAdditionalPreview();
        }

        // 팀 멤버 목록 로드
        async function loadMembers() {
            const membersList = document.getElementById('membersList');
            const loader = document.getElementById('membersLoader');
            
            try {
                loader.classList.remove('hidden');
                membersList.innerHTML = '';

                if (!isFirebaseReady) {
                    membersList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Firebase 연결을 확인해주세요.</td></tr>';
                    return;
                }

                const { collection, getDocs, query, orderBy } = window.firestoreFunctions;
                
                // orderBy 없이 먼저 시도
                let q;
                try {
                    q = query(collection(window.db, 'team'), orderBy('createdAt', 'desc'));
                } catch (error) {
                    q = query(collection(window.db, 'team'));
                }
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    membersList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">등록된 멤버가 없습니다.</td></tr>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const member = doc.data();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${member.name || '이름 없음'}</td>
                            <td>${member.position || '직책 없음'}</td>
                            <td>${member.email || '이메일 없음'}</td>
                            <td>
                                ${member.image ? `<img src="${member.image}" alt="${member.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : '이미지 없음'}
                            </td>
                            <td>
                                <button class="btn-edit" onclick="handleEditMember(this, '${doc.id}')">수정</button>
                                <button class="btn-danger" onclick="deleteMember('${doc.id}', '${member.name}')">삭제</button>
                            </td>
                        `;
                        membersList.appendChild(row);
                    });
                }
                
            } catch (error) {
                console.error('멤버 로드 실패:', error);
                membersList.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;">멤버 목록을 불러오는데 실패했습니다.</td></tr>';
            } finally {
                loader.classList.add('hidden');
            }
        }

        // 멤버 수정 처리
        async function handleEditMember(button, memberId) {
            try {
                const { doc, getDoc } = window.firestoreFunctions;
                const memberDoc = await getDoc(doc(window.db, 'team', memberId));
                
                if (memberDoc.exists()) {
                    const member = memberDoc.data();
                    
                    // 폼에 기존 데이터 채우기
                    document.getElementById('memberName').value = member.name || '';
                    document.getElementById('memberPosition').value = member.position || '';
                    document.getElementById('memberEmail').value = member.email || '';
                    
                    // 수정 모드 표시
                    const submitBtn = document.querySelector('#memberAddForm button[type="submit"]');
                    submitBtn.textContent = '멤버 수정';
                    
                    // 수정 완료 후 목록 새로고침을 위해 멤버 ID 저장
                    submitBtn.dataset.editingMemberId = memberId;
                    
                    // 폼으로 스크롤
                    document.querySelector('#memberAddForm').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('멤버 수정 로드 실패:', error);
                alert('멤버 정보를 불러오는데 실패했습니다.');
            }
        }



        // 멤버 삭제
        async function deleteMember(memberId, memberName) {
            if (confirm(`"${memberName}" 멤버를 정말 삭제하시겠습니까?`)) {
                try {
                    const { doc, deleteDoc } = window.firestoreFunctions;
                    await deleteDoc(doc(window.db, 'team', memberId));
                    alert('멤버가 삭제되었습니다!');
                    await loadMembers(); // 목록 새로고침
                } catch (error) {
                    console.error('멤버 삭제 실패:', error);
                    alert('멤버 삭제에 실패했습니다: ' + error.message);
                }
            }
        }

        // 멤버 추가/수정 폼 Firestore 저장
        document.getElementById('memberAddForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('memberName').value.trim();
            const position = document.getElementById('memberPosition').value.trim();
            const email = document.getElementById('memberEmail').value.trim();
            const imageFile = document.getElementById('memberImage').files[0];
            
            if (!name || !position || !email) {
                alert('모든 필드를 입력해주세요.');
                return;
            }

            try {
                let imageBase64 = '';
                
                if (imageFile) {
                    // 새 이미지가 선택된 경우 - 1MB 제한을 위한 강한 압축
                    imageBase64 = await compressImage(imageFile, 500, 0.5);
                }

                const submitBtn = this.querySelector('button[type="submit"]');
                const editingMemberId = submitBtn.dataset.editingMemberId;

                if (editingMemberId) {
                    // 수정 모드
                    const { doc, updateDoc } = window.firestoreFunctions;
                    const updateData = {
                        name, position, email,
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (imageBase64) {
                        updateData.image = imageBase64;
                    }
                    
                    await updateDoc(doc(window.db, 'team', editingMemberId), updateData);
                    alert('멤버가 성공적으로 수정되었습니다!');
                    
                    // 수정 모드 해제
                    delete submitBtn.dataset.editingMemberId;
                    submitBtn.textContent = '멤버 추가';
                } else {
                    // 새 멤버 추가
                    if (!imageFile) {
                        alert('이미지를 선택해주세요.');
                        return;
                    }
                    
                    const { collection, addDoc } = window.firestoreFunctions;
                    await addDoc(collection(window.db, 'team'), {
                        name, position, email, image: imageBase64, createdAt: new Date().toISOString()
                    });
                    alert('멤버가 성공적으로 추가되었습니다!');
                }
                
                this.reset();
                await loadMembers(); // 목록 새로고침
                
            } catch (err) {
                alert('멤버 저장 실패: ' + err.message);
            }
        });

        // 페이지 로드 시 Firebase 상태 체크
        window.addEventListener('load', function() {
            console.log('페이지 로드됨 - 로그인 상태:', isLoggedIn);
            console.log('Firebase 초기 상태:', isFirebaseReady);
            console.log('window.db:', window.db);
            console.log('window.firestoreFunctions:', window.firestoreFunctions);
            
            if (isLoggedIn) {
                console.log('로그인된 상태에서 Firebase 준비 확인 시작');
                checkFirebaseReady().then((ready) => {
                    console.log('Firebase 준비 확인 결과:', ready);
                    if (ready) {
                        loadProjects();
                        loadMembers(); // 팀 멤버 목록도 함께 로드
                    }
                });
            }
        });

        // Firebase 연결 상태 확인 후 멤버 로드 재시도
        setTimeout(() => {
            console.log('2초 후 Firebase 상태 재확인:', isFirebaseReady);
            if (isFirebaseReady && isLoggedIn) {
                console.log('2초 후 멤버 로드 재시도');
                loadMembers();
            }
        }, 2000);

        // 추가 안전장치: 5초 후에도 로드되지 않으면 재시도
        setTimeout(() => {
            console.log('5초 후 Firebase 상태 재확인:', isFirebaseReady);
            if (isFirebaseReady && isLoggedIn) {
                console.log('5초 후 멤버 로드 재시도');
                loadMembers();
            }
        }, 5000);

        // Firebase 연결 상태 확인 (페이지 로드 시)
        setTimeout(() => {
            console.log('5초 후 Firebase 연결 상태 최종 확인:', isFirebaseReady);
            if (!isFirebaseReady) {
                console.log('Firebase 연결 실패 - 상태 업데이트');
                updateFirebaseStatus(false, 'Firebase 설정값을 확인해주세요');
            }
        }, 5000);


    </script>
</body>
</html> 